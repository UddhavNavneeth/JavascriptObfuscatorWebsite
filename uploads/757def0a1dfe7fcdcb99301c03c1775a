const express=require('express')
var fs = require('fs');
var youtubedl = require('youtube-dl');
app=express()
app.use(express.json())

port=process.env.PORT||3000

app.post('/getinfo',(req,res)=>{
  youtubedl.getInfo(req.body.url,(err,info)=>{
    if(err){
      return err
    }
    obj={
      url:req.body.url,
      name:info.title,
      filename:info._filename,
      thumbnail:info.thumbnail,
      desc:info.description,
      formats:[],
    }
  
  
    for(var i=0;i<info.formats.length;i++){
      data={
        size:(info.formats[i].filesize)/1000000,
        formatdesc:info.formats[i].format,
        format_id:info.formats[i].format_id
      }
      obj.formats.push(data)
  
    }
  
    res.send(obj)
  })
})

app.post('/downloadvideo',(req,res)=>{
  const id=req.body.format_id
  const formatid='--format='+id
  var video = youtubedl(req.body.url,
    
  [formatid],
  { cwd: __dirname });
  video.pipe(fs.createWriteStream(req.body.filename));
  res.download(req.body.filename)
  fs.unlinkSync(req.body.filename)
  res.send('Job Done')

})

app.listen(port,()=>{
    console.log('Listening on Port '+port)
})